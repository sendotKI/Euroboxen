<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Eurobox</title>
  <style>
    :root{
      --bg1:#05070c;
      --cardTint: rgba(255,255,255,.00); /* wird per JS gesetzt */
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.55);
      --good:#39d98a;

      --boxGrey:#C0C0C0;
      --boxBlack:#000000;
      --boxKarton:#ADAC62;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      background: radial-gradient(1200px 700px at 50% -200px, #1a2a55 0%, var(--bg1) 35%) ,
                  radial-gradient(900px 700px at 50% 120%, #0b1a3c 0%, var(--bg1) 45%);
      padding: 18px 14px 24px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }

    .wrap{ width:min(560px, 100%); margin-top: 8px; }

    .card{
      position:relative;
      border-radius: 26px;
      padding: 18px 16px 16px;
      overflow:hidden;
      border:1px solid var(--stroke);
      box-shadow: 0 25px 60px rgba(0,0,0,.45);

      /* Grundlook + T√∂nung je nach Boxfarbe */
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)),
        linear-gradient(180deg, var(--cardTint), var(--cardTint));
    }

    .colorBar{
      position:absolute;
      top:10px; left:12px; right:12px;
      height:10px;
      border-radius: 999px;
      opacity:.65;
      border:1px solid rgba(255,255,255,.10);
      display:block;
    }

    .head{ text-align:center; padding-top: 8px; }
    .boxId{
      font-weight: 900;
      letter-spacing: .08em;
      font-size: 56px;
      line-height: 1.0;
      margin: 10px 0 6px;
      text-shadow: 0 6px 20px rgba(0,0,0,.35);
    }
    .status{
      font-weight: 700;
      color: var(--good);
      margin-bottom: 14px;
    }
    .status.saving{ color: rgba(255,255,255,.45); }

    .gridTop{
      display:grid;
      grid-template-columns: 1fr 2fr;
      gap: 12px;
      margin-top: 8px;
    }

    .input{
      width:100%;
      height: 54px;
      padding: 0 14px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 18px;
      outline:none;
    }
    .input::placeholder{ color: rgba(255,255,255,.35); }
    .input:focus{ border-color: rgba(120,160,255,.35); }

    .row2{
      display:grid;
      grid-template-columns: 58px 58px 1fr;
      gap: 12px;
      margin-top: 12px;
      align-items:center;
    }

    .chip{
      width:58px; height:58px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      position:relative;
      transition: transform .06s ease, box-shadow .15s ease, border-color .15s ease;
      font-size: 26px;
    }
    .chip:active{ transform: scale(.98); }
    .chip.active{
      border-color: rgba(57,217,138,.65);
      box-shadow: 0 0 0 3px rgba(57,217,138,.18);
    }

    .chip.danger.active{
      border-color: rgba(255,77,77,.70);
      box-shadow: 0 0 0 3px rgba(255,77,77,.18);
    }

    .chip.fragile::after{
      content:"üí•";
      position:absolute;
      right:6px;
      bottom:6px;
      font-size: 14px;
      opacity: .0;
      transform: rotate(-10deg);
      transition: opacity .15s ease;
      pointer-events:none;
    }
    .chip.fragile.active::after{ opacity:.9; }

    .weightWrap{
      height:58px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      padding: 0 12px;
      gap: 10px;
    }
    .weightInput{
      width: 72px;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 22px;
      font-weight: 800;
      text-align:center;
      appearance: textfield;
    }
    .weightInput::-webkit-outer-spin-button,
    .weightInput::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    .kg{
      margin-left:auto;
      color: rgba(255,255,255,.55);
      font-weight: 800;
      font-size: 22px;
      padding-right: 4px;
    }

    .colorRow{
      display:flex;
      align-items:center;
      gap: 10px;
      margin-top: 12px;
      margin-bottom: 14px;
    }
    .swatch{
      width: 28px; height: 28px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.22);
      cursor:pointer;
      position:relative;
      flex:0 0 auto;
    }
    .swatch.active{
      outline: 3px solid rgba(57,217,138,.35);
      border-color: rgba(57,217,138,.60);
    }
    .swatch.grey{ background: var(--boxGrey); }
    .swatch.black{ background: #000; }

    .content{
      border-radius: 20px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      padding: 12px;
    }
    textarea{
      width:100%;
      min-height: 260px;
      resize: vertical;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 18px;
      line-height: 1.4;
    }
    textarea::placeholder{ color: rgba(255,255,255,.30); }

    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    .btn{
      height: 58px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(40,70,140,.22);
      color: var(--text);
      font-size: 18px;
      font-weight: 800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 0 10px;
    }
    .hint{
      margin-top: 8px;
      color: rgba(255,255,255,.40);
      font-size: 13px;
      text-align:center;
    }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="colorBar" id="colorBar"></div>

      <div class="head">
        <div class="boxId" id="boxId">E000</div>
        <div class="status" id="status">Gespeichert ‚úì</div>
      </div>

      <div class="gridTop">
        <input class="input" id="ort" maxlength="6" placeholder="ORT" />
        <input class="input" id="bez" placeholder="Bezeichnung" />
      </div>

      <div class="row2">
        <div class="chip fragile" id="fragile" title="Zerbrechlich">üç∑</div>
        <div class="chip danger" id="heavy" title="Schwer (ab 16 kg)">üèãÔ∏è</div>

        <div class="weightWrap">
          <input class="weightInput" id="kg" inputmode="numeric" pattern="[0-9]*" maxlength="2" placeholder="00" />
          <div class="kg">kg</div>
        </div>
      </div>

      <div class="colorRow" id="colorRow">
        <div class="swatch grey" id="swGrey" title="Grau"></div>
        <div class="swatch black" id="swBlack" title="Schwarz"></div>
      </div>

      <div class="content">
        <textarea id="text" placeholder="‚Ä¢ Inhalt hier eintragen..."></textarea>
      </div>

      <div class="btnRow">
        <button class="btn" id="btnBackup">Backup nach iCloud</button>
        <button class="btn" id="btnImport">Backup importieren</button>
      </div>

      <div class="hint">iPhone: Backup ‚Üí Teilen ‚Üí ‚ÄûIn Dateien sichern‚Äú ‚Üí iCloud Drive</div>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "eurobox_data_v1";
  const $ = (id) => document.getElementById(id);

  const elBoxId = $("boxId");
  const elStatus = $("status");
  const elOrt = $("ort");
  const elBez = $("bez");
  const elFragile = $("fragile");
  const elHeavy = $("heavy");
  const elKg = $("kg");
  const elText = $("text");
  const elSwGrey = $("swGrey");
  const elSwBlack = $("swBlack");
  const elColorRow = $("colorRow");
  const elColorBar = $("colorBar");
  const elCard = $("card");

  const btnBackup = $("btnBackup");
  const btnImport = $("btnImport");

  // --- BoxId aus URL ---
  const params = new URLSearchParams(location.search);
  const rawId = (params.get("box") || "E000").toUpperCase().trim();
  const boxId = /^[EK]\d{3}$/.test(rawId) ? rawId : "E000";
  elBoxId.textContent = boxId;
  document.title = boxId;

  const isK = boxId.startsWith("K");

  function loadAll(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveAll(all){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
  }
  function nowISO(){ return new Date().toISOString(); }

  function defaultColorFor(){
    return isK ? "karton" : "grey";
  }

  function colorToHex(color){
    if (color === "black") return "#000000";
    if (color === "karton") return "#ADAC62";
    return "#C0C0C0";
  }

  // deutliche Karton-T√∂nung im Card-Background (nicht zu heftig)
  function tintFor(color){
    if (color === "karton") return "rgba(173,172,98,.22)";
    if (color === "black")  return "rgba(0,0,0,.10)";
    return "rgba(192,192,192,.16)";
  }

  let all = loadAll();
  let item = all[boxId] || {
    id: boxId,
    ort: "",
    bez: "",
    text: "",
    fragile: false,
    weight: 0,
    color: defaultColorFor(),
    updatedAt: nowISO()
  };

  // ‚úÖ HART: Kartons immer karton ‚Äì egal was gespeichert war
  function enforceKarton(){
    if (isK) item.color = "karton";
  }
  enforceKarton();

  // --- UI ---
  function setSaving(saving){
    if (saving){
      elStatus.textContent = "Speichern‚Ä¶";
      elStatus.classList.add("saving");
    } else {
      elStatus.textContent = "Gespeichert ‚úì";
      elStatus.classList.remove("saving");
    }
  }

  function renderColorUI(){
    enforceKarton();

    const hex = colorToHex(item.color);
    elColorBar.style.background = hex;

    // Card-T√∂nung setzen
    elCard.style.setProperty("--cardTint", tintFor(item.color));

    if (isK){
      elColorRow.classList.add("hidden");
      return;
    }
    elColorRow.classList.remove("hidden");
    elSwGrey.classList.toggle("active", item.color === "grey");
    elSwBlack.classList.toggle("active", item.color === "black");
  }

  function heavyByWeight(){
    const w = Number(item.weight || 0);
    elHeavy.classList.toggle("active", w >= 16); // ‚úÖ erst ab 16kg
  }

  function render(){
    enforceKarton();

    elOrt.value = item.ort || "";
    elBez.value = item.bez || "";
    elText.value = item.text || "";
    elFragile.classList.toggle("active", !!item.fragile);

    const w = Number(item.weight || 0);
    elKg.value = w ? String(w) : "";

    heavyByWeight();
    renderColorUI();
  }

  // --- Autosave ---
  let t = null;
  function scheduleSave(){
    enforceKarton(); // ‚úÖ auch vor jedem Save erzwingen

    setSaving(true);
    clearTimeout(t);
    t = setTimeout(() => {
      enforceKarton();
      item.updatedAt = nowISO();
      all[boxId] = item;
      saveAll(all);
      setSaving(false);
    }, 250);
  }

  // --- Bullets ---
  function normalizeBullets(text){
    const lines = text.replace(/\r/g, "").split("\n");
    return lines.map(line => {
      const trimmed = line.replace(/^\s+/, "");
      if (trimmed === "") return "";
      if (trimmed.startsWith("‚Ä¢ ")) return "‚Ä¢ " + trimmed.slice(2);
      if (trimmed.startsWith("‚Ä¢")) return "‚Ä¢ " + trimmed.slice(1).trimStart();
      return "‚Ä¢ " + trimmed;
    }).join("\n");
  }

  elText.addEventListener("keydown", (e) => {
    if (e.key === "Backspace"){
      const start = elText.selectionStart;
      const end = elText.selectionEnd;
      if (start !== end) return;

      const value = elText.value;
      const before = value.slice(0, start);
      const lineStart = before.lastIndexOf("\n") + 1;
      const at = start - lineStart;
      const linePrefix = value.slice(lineStart, lineStart + 2);

      if (at === 2 && linePrefix === "‚Ä¢ "){
        e.preventDefault();
        elText.value = value.slice(0, lineStart) + value.slice(lineStart + 2);
        elText.setSelectionRange(start - 2, start - 2);
        item.text = normalizeBullets(elText.value);
        scheduleSave();
      }
    }
  });

  elText.addEventListener("input", () => {
    const pos = elText.selectionStart;
    const oldLen = elText.value.length;

    elText.value = normalizeBullets(elText.value);

    const newLen = elText.value.length;
    const delta = newLen - oldLen;
    elText.setSelectionRange(Math.max(0, pos + delta), Math.max(0, pos + delta));

    item.text = elText.value;
    scheduleSave();
  });

  // Inputs
  elOrt.addEventListener("input", () => {
    item.ort = (elOrt.value || "").toUpperCase().slice(0,6);
    elOrt.value = item.ort;
    scheduleSave();
  });

  elBez.addEventListener("input", () => {
    item.bez = (elBez.value || "");
    scheduleSave();
  });

  elFragile.addEventListener("click", () => {
    item.fragile = !item.fragile;
    elFragile.classList.toggle("active", !!item.fragile);
    scheduleSave();
  });

  // Heavy nicht manuell toggeln
  elHeavy.addEventListener("click", () => {
    elHeavy.style.transform = "scale(.98)";
    setTimeout(()=> elHeavy.style.transform = "", 80);
  });

  elKg.addEventListener("input", () => {
    let v = (elKg.value || "").replace(/\D/g, "").slice(0,2);
    elKg.value = v;
    item.weight = v ? Number(v) : 0;
    heavyByWeight();
    scheduleSave();
  });

  elSwGrey.addEventListener("click", () => {
    if (isK) return;
    item.color = "grey";
    renderColorUI();
    scheduleSave();
  });
  elSwBlack.addEventListener("click", () => {
    if (isK) return;
    item.color = "black";
    renderColorUI();
    scheduleSave();
  });

  // Backup Export/Import
  function buildBackup(){
    const fresh = loadAll();
    return { version: 1, exportedAt: nowISO(), data: fresh };
  }

  async function shareOrDownload(filename, blob){
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename, { type: blob.type })] })){
      try{
        await navigator.share({ files: [new File([blob], filename, { type: blob.type })], title: filename });
        return;
      }catch(e){}
    }
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  btnBackup.addEventListener("click", async () => {
    const blob = new Blob([JSON.stringify(buildBackup(), null, 2)], { type:"application/json" });
    const name = `Euroboxen_Backup_${new Date().toISOString().slice(0,10)}.json`;
    await shareOrDownload(name, blob);
  });

  btnImport.addEventListener("click", () => {
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = ".json,application/json";
    inp.addEventListener("change", async () => {
      const file = inp.files && inp.files[0];
      if (!file) return;
      const txt = await file.text();
      let parsed;
      try { parsed = JSON.parse(txt); }
      catch { alert("Ung√ºltige JSON-Datei."); return; }

      const incoming = parsed && parsed.data && typeof parsed.data === "object" ? parsed.data : null;
      if (!incoming){ alert("Backup-Format nicht erkannt."); return; }

      const current = loadAll();
      const merged = { ...current, ...incoming };

      // ‚úÖ Kartons in merged fixieren
      for (const k of Object.keys(merged)){
        if (k.startsWith("K") && merged[k]) merged[k].color = "karton";
      }

      saveAll(merged);
      all = merged;

      item = all[boxId] || item;
      enforceKarton();
      render();
      setSaving(false);
      alert("Backup importiert ‚úì");
    });
    inp.click();
  });

  // init
  render();
  setSaving(false);
})();
</script>
</body>
</html>
