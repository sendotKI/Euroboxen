<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Euroboxen</title>

  <style>
    :root{
      --bg:#071225;

      /* E */
      --eGrey:#2b3447;
      --eBlack:#000000;

      /* K / T */
      --kCard:#ADAC62;
      --tCard:#9FFCFD;

      --ok:#27d17e;
      --ink:#e9eef7;

      --stroke:rgba(255,255,255,.12);
      --tileBg:rgba(0,0,0,.18);

      --glowGreen:rgba(39,209,126,.42);
      --glowRed:rgba(255,80,80,.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:22px 12px;
      background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
    }

    .card{
      width:min(640px,94vw);
      border-radius:28px;
      padding:18px 18px 16px;
      background:var(--eGrey);
      box-shadow:0 26px 70px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }

    .topbar{
      height:10px;
      width:92%;
      margin:4px auto 14px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
    }

    /* √úberschrift kleiner */
    h1{
      margin:0;
      text-align:center;
      font-size:52px;
      font-weight:900;
      letter-spacing:1px;
    }
    .status{
      margin-top:6px;
      text-align:center;
      font-size:24px;
      font-weight:900;
      color:var(--ok);
    }

    /* ====== LAYOUT wie E022 ====== */
    .rowFields{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:18px;
    }
    .rowIcons{
      display:grid;
      grid-template-columns: 76px 76px 1fr;
      gap:14px;
      margin-top:14px;
      align-items:stretch;
    }

    /* falls schmal -> stacken, aber Reihenfolge bleibt */
    @media (max-width: 380px){
      .rowFields{ grid-template-columns:1fr; }
      .rowIcons{ grid-template-columns: 76px 1fr; grid-auto-rows:72px; }
      .kgTile{ grid-column: 1 / -1; }
    }

    .input{
      height:62px;
      border-radius:18px;
      border:2px solid var(--stroke);
      background:var(--tileBg);
      color:var(--ink);
      font-size:22px;
      padding:0 16px;
      outline:none;
    }
    .input::placeholder{ color:rgba(233,238,247,.45); font-weight:700; }

    .tile{
      height:72px;
      border-radius:18px;
      border:2px solid var(--stroke);
      background:var(--tileBg);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:30px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tile.btn{ cursor:pointer; }

    .tile.active.fragile{ box-shadow:0 0 0 4px var(--glowGreen); }
    .tile.active.heavy{ box-shadow:0 0 0 4px var(--glowRed); }

    /* kg Tile (komfortabel klickbar wie die anderen) */
    .kgTile{
      justify-content:center;
      gap:12px;
      padding:0 14px;
      cursor:text;
    }
    .kgTile input{
      width:140px;
      text-align:center;
      border:none;
      outline:none;
      background:transparent;
      color:var(--ink);
      font-size:40px;
      font-weight:900;
      letter-spacing:1px;
      padding:0;
    }
    .kgTile .unit{
      font-size:30px;
      font-weight:900;
      opacity:.9;
    }

    /* Farbfelder (nur f√ºr E) */
    .colorRow{
      display:flex;
      gap:18px;
      margin-top:14px;
      margin-bottom:18px; /* mehr Abstand zum Inhaltsfeld */
      align-items:center;
    }
    .colorBox{
      width:42px;
      height:42px;
      border-radius:12px;
      border:2px solid var(--stroke);
      background:var(--tileBg);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .colorBox.black{ background:#000; }
    .colorBox.grey{ background:#c0c0c0; }
    .colorBox.active{ box-shadow:0 0 0 4px var(--glowGreen); }

    .contentWrap{
      border-radius:22px;
      border:2px solid var(--stroke);
      background:var(--tileBg);
      padding:12px;
      margin-top:0;
    }
    textarea{
      width:100%;
      height:320px;
      border:none;
      outline:none;
      background:transparent;
      color:var(--ink);
      font-size:22px;
      resize:none;
    }
    textarea::placeholder{ color:rgba(233,238,247,.45); font-weight:700; }

    .btnRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      margin-top:16px;
    }
    button{
      height:72px;
      border-radius:18px;
      border:none;
      background:#263a5f;
      color:#fff;
      font-size:22px;
      font-weight:900;
    }

    /* ===== Modus je ID ===== */
    .mode-eblack{ background:var(--eBlack); }
    .mode-eblack .topbar{ background:rgba(255,255,255,.12); }

    .mode-egrey{ background:var(--eGrey); }

    .mode-k{ background:var(--kCard); color:#111; }
    .mode-k .topbar{ background:rgba(0,0,0,.12); }
    .mode-k .input, .mode-k .tile, .mode-k .contentWrap{
      background:rgba(255,255,255,.25);
      border-color:rgba(0,0,0,.22);
      color:#111;
    }
    .mode-k textarea, .mode-k .kgTile input{ color:#111; }
    .mode-k .input::placeholder, .mode-k textarea::placeholder{ color:rgba(0,0,0,.35); }

    .mode-t{ background:var(--tCard); color:#111; }
    .mode-t .topbar{ background:rgba(0,0,0,.12); }
    .mode-t .input, .mode-t .tile, .mode-t .contentWrap{
      background:rgba(255,255,255,.35);
      border-color:rgba(0,0,0,.22);
      color:#111;
    }
    .mode-t textarea, .mode-t .kgTile input{ color:#111; }
    .mode-t .input::placeholder, .mode-t textarea::placeholder{ color:rgba(0,0,0,.35); }
  </style>
</head>

<body>
  <div class="card mode-egrey" id="card">
    <div class="topbar"></div>

    <h1 id="boxId">E001</h1>
    <div class="status" id="status">Gespeichert ‚úì</div>

    <!-- Zeile 1: ORT + Bezeichnung (wie E022) -->
    <div class="rowFields">
      <input id="ort" class="input" placeholder="ORT" maxlength="6" />
      <input id="bez" class="input" placeholder="Bezeichnung" />
    </div>

    <!-- Zeile 2: üç∑ + üèãÔ∏è + KG (wie E022) -->
    <div class="rowIcons">
      <div id="fragile" class="tile btn">üç∑</div>
      <div id="heavy" class="tile btn">üèãÔ∏è</div>

      <div id="kgTile" class="tile kgTile">
        <input id="kg" inputmode="numeric" pattern="[0-9]*" maxlength="2" value="00" />
        <span class="unit">kg</span>
      </div>
    </div>

    <!-- Zeile 3: Farbe nur f√ºr E -->
    <div class="colorRow" id="colorRow">
      <div id="cBlack" class="colorBox black" title="Schwarz"></div>
      <div id="cGrey" class="colorBox grey" title="Grau"></div>
    </div>

    <!-- Zeile 4: Inhalt -->
    <div class="contentWrap">
      <textarea id="content" placeholder="‚Ä¢ Inhalt hier eintragen..."></textarea>
    </div>

    <!-- Unten: Buttons -->
    <div class="btnRow">
      <button id="backupBtn">Backup nach iCloud</button>
      <button id="importBtn">Backup importieren</button>
    </div>
  </div>

<script>
/* ---------------- Helpers ---------------- */
const $ = (id)=>document.getElementById(id);
const statusEl = $("status");
const card = $("card");

const params = new URLSearchParams(location.search);
const boxId = (params.get("box") || "E001").toUpperCase();
$("boxId").textContent = boxId;

function setStatusSaving(){ statusEl.textContent = "Speichert‚Ä¶"; }
function setStatusSaved(){ statusEl.textContent = "Gespeichert ‚úì"; }
let saveTimer = null;

function getStore(){
  try { return JSON.parse(localStorage.getItem("euroboxen") || "{}"); }
  catch { return {}; }
}
function setStore(obj){
  localStorage.setItem("euroboxen", JSON.stringify(obj));
}

/* ---------------- Mode by prefix ---------------- */
const colorRow = $("colorRow");

function applyMode(mode){
  card.className = "card " + mode;
}
function hideColorPick(){ colorRow.style.display="none"; }
function showColorPick(){ colorRow.style.display="flex"; }

if (boxId.startsWith("K")) { applyMode("mode-k"); hideColorPick(); }
else if (boxId.startsWith("T")) { applyMode("mode-t"); hideColorPick(); }
else { applyMode("mode-egrey"); showColorPick(); }

/* ---------------- Load current box ---------------- */
function loadBox(){
  const db = getStore();
  const v = db[boxId] || {};

  $("ort").value = v.ort || "";
  $("bez").value = v.bez || "";
  $("content").value = v.content || "";

  // fragile
  $("fragile").classList.toggle("active", !!v.fragile);

  // kg
  $("kg").value = (v.kg ?? "00").toString();
  normalizeKg(false);

  // Eurobox color choice (nur E)
  if (!boxId.startsWith("K") && !boxId.startsWith("T")){
    const col = v.color || "grey";
    setEuroColor(col, false);
  }

  setStatusSaved();
}
loadBox();

/* ---------------- Save current box ---------------- */
function saveBox(){
  const db = getStore();
  db[boxId] = db[boxId] || {};

  db[boxId].ort = $("ort").value.trim();
  db[boxId].bez = $("bez").value.trim();
  db[boxId].content = $("content").value;

  db[boxId].fragile = $("fragile").classList.contains("active");
  db[boxId].kg = $("kg").value;

  if (!boxId.startsWith("K") && !boxId.startsWith("T")){
    db[boxId].color = (card.classList.contains("mode-eblack") ? "black" : "grey");
  }

  setStore(db);
}

function scheduleSave(){
  setStatusSaving();
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{
    saveBox();
    setStatusSaved();
  }, 250);
}

/* ---------------- Euro color selection (only E*) ---------------- */
function setEuroColor(color, doSave=true){
  if (boxId.startsWith("K") || boxId.startsWith("T")) return;

  $("cBlack").classList.toggle("active", color==="black");
  $("cGrey").classList.toggle("active", color==="grey");
  applyMode(color==="black" ? "mode-eblack" : "mode-egrey");

  if (doSave) scheduleSave();
}
$("cBlack").addEventListener("click", ()=>setEuroColor("black"));
$("cGrey").addEventListener("click", ()=>setEuroColor("grey"));

/* ---------------- Icon toggles ---------------- */
$("fragile").addEventListener("click",(e)=>{
  e.preventDefault(); e.stopPropagation();
  $("fragile").classList.toggle("active");
  scheduleSave();
});

/* Heavy automatisch ab 16 kg */
function setHeavyAuto(on){
  $("heavy").classList.toggle("active", on);
}

/* ---------------- KG: iOS-freundlich, 2-stellig ---------------- */
const kgInput = $("kg");
const kgTile = $("kgTile");

function selectAllKg(){
  setTimeout(()=>{
    kgInput.focus({preventScroll:true});
    try { kgInput.setSelectionRange(0, kgInput.value.length); } catch {}
  }, 0);
}

kgTile.addEventListener("click",(e)=>{
  e.preventDefault(); e.stopPropagation();
  selectAllKg();
});

kgInput.addEventListener("focus", ()=>{
  selectAllKg();
});

kgInput.addEventListener("input", ()=>{
  // beim Tippen nur reinigen, NICHT auff√ºllen (sonst ‚Äúnur einstellig‚Äù)
  kgInput.value = kgInput.value.replace(/\D/g,"").slice(0,2);
  const v = parseInt(kgInput.value || "0", 10);
  setHeavyAuto(v >= 16);
  scheduleSave();
});

kgInput.addEventListener("blur", ()=>{
  normalizeKg(true);
  scheduleSave();
});

function normalizeKg(setSaved){
  let s = (kgInput.value || "").replace(/\D/g,"").slice(0,2);
  if (s.length===0) s="00";
  if (s.length===1) s="0"+s;      // erst beim Verlassen auff√ºllen
  kgInput.value = s;
  const v = parseInt(s,10) || 0;
  setHeavyAuto(v >= 16);
  if(setSaved) setStatusSaved();
}

/* ---------------- Content bullets ---------------- */
const content = $("content");

content.addEventListener("focus", ()=>{
  if (content.value.trim()===""){
    content.value = "‚Ä¢ ";
    setTimeout(()=>content.setSelectionRange(content.value.length, content.value.length), 0);
  }
});

content.addEventListener("keydown", (e)=>{
  if(e.key==="Backspace"){
    const pos = content.selectionStart;
    const before = content.value.slice(0,pos);
    const lineStart = before.lastIndexOf("\n")+1;
    const line = before.slice(lineStart);
    if(line === "‚Ä¢ "){
      e.preventDefault();
      const after = content.value.slice(pos);
      content.value = content.value.slice(0,lineStart) + after;
      content.setSelectionRange(lineStart,lineStart);
      scheduleSave();
    }
  }
  if(e.key==="Enter"){
    e.preventDefault();
    const pos = content.selectionStart;
    const left = content.value.slice(0,pos);
    const right = content.value.slice(pos);
    content.value = left + "\n‚Ä¢ " + right;
    const np = pos + 3;
    content.setSelectionRange(np,np);
    scheduleSave();
  }
});

/* ---------------- Generic autosave for inputs ---------------- */
["ort","bez"].forEach(id=>{
  $(id).addEventListener("input", scheduleSave);
});
content.addEventListener("input", scheduleSave);

/* ---------------- Backup / Import ---------------- */
$("backupBtn").addEventListener("click", async ()=>{
  const data = getStore();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const file = new File([blob], "euroboxen.json", {type:"application/json"});

  if (navigator.canShare && navigator.canShare({files:[file]})) {
    try { await navigator.share({files:[file], title:"Euroboxen Backup"}); return; }
    catch {}
  }

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "euroboxen.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

$("importBtn").addEventListener("click", ()=>{
  const inp = document.createElement("input");
  inp.type="file";
  inp.accept="application/json";
  inp.onchange = async ()=>{
    const f = inp.files?.[0];
    if(!f) return;
    const txt = await f.text();
    let incoming = {};
    try { incoming = JSON.parse(txt); } catch { return; }

    const db = getStore();
    for(const k of Object.keys(incoming)){
      db[k] = incoming[k];
    }
    setStore(db);
    loadBox();
  };
  inp.click();
});
</script>
</body>
</html>
