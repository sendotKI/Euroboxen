<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Box</title>

<style>
  :root{
    --karton:#ADAC62;
    --euroGrey:#C0C0C0;
    --euroBlack:#0b0f19;

    --bg1:#050914;
    --bg2:#02040a;

    --card:#0b1220;
    --card2:#0a1020;

    --text:#e7eaf0;
    --muted:#9aa3b2;

    --border: rgba(255,255,255,.12);
    --field: rgba(255,255,255,.07);

    --ok:#22c55e;
    --warn:#ef4444;
    --chip: rgba(255,255,255,.08);
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    color:var(--text);
    background: radial-gradient(1100px 600px at 50% -10%, #0b1a3a 0%, var(--bg1) 38%, var(--bg2) 100%);
    padding: 18px 12px;
  }

  .wrap{max-width:560px;margin:0 auto;}
  .card{
    position:relative;
    border-radius:28px;
    padding:18px;
    border:1px solid rgba(255,255,255,.10);
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)) , var(--card);
    box-shadow: 0 20px 70px rgba(0,0,0,.55);
    overflow:hidden;
  }

  /* Dezente T√∂nung (NICHT alles grau machen!) */
  .card::before{
    content:"";
    position:absolute; inset:0;
    background: radial-gradient(900px 420px at 50% 0%, rgba(255,255,255,.06), transparent 55%);
    pointer-events:none;
    opacity:1;
  }

  /* Farbbalken oben */
  .topbar{
    position:absolute; left:18px; right:18px; top:14px;
    height:10px;
    border-radius:10px;
    background: var(--accentColor);
    opacity:.28;
    filter: saturate(1.2);
  }

  .title{
    position:relative;
    text-align:center;
    font-weight:900;
    letter-spacing:3px;
    font-size:52px;
    margin: 18px 0 4px 0;
    text-shadow: 0 8px 20px rgba(0,0,0,.35);
  }

  .status{
    position:relative;
    text-align:center;
    color: var(--ok);
    font-weight:700;
    margin-bottom: 14px;
  }

  .row{position:relative; display:flex; gap:12px; margin:12px 0;}
  .field{
    width:100%;
    background: var(--field);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 16px;
    padding: 14px 14px;
    font-size:16px;
    outline:none;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
  }
  .field::placeholder{color: rgba(231,234,240,.45);}

  .ort{max-width:140px; font-weight:800; letter-spacing:1px; text-transform:uppercase;}
  .bez{flex:1;}

  .iconToggle{
    width:56px; height:56px;
    border-radius:18px;
    display:flex; align-items:center; justify-content:center;
    background: var(--chip);
    border: 2px solid transparent;
    cursor:pointer;
    user-select:none;
    font-size:24px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
  }
  .iconToggle.active{
    border-color: rgba(34,197,94,.9);
    background: rgba(34,197,94,.22);
  }
  .iconToggle.heavy.active{
    border-color: rgba(239,68,68,.95);
    background: rgba(239,68,68,.25);
  }

  /* Gewicht: Input + "kg" fest */
  .kgWrap{
    flex:1;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .kgBox{
    position:relative;
    flex:1;
  }
  .kgInput{
    padding-right:44px;
    text-align:center;
    font-weight:900;
    letter-spacing:1px;
    font-variant-numeric: tabular-nums;
  }
  .kgSuffix{
    position:absolute;
    right:14px; top:50%;
    transform:translateY(-50%);
    color: rgba(231,234,240,.60);
    font-weight:800;
    pointer-events:none;
  }

  /* Farbauswahl kleiner + Abstand zum Inhaltsfeld */
  .colorRow{
    display:flex;
    gap:10px;
    margin: 6px 0 18px 0; /* Abstand zum Inhaltsfeld */
    transform: scale(.5);
    transform-origin: left center;
  }

  .colorChip{
    width:84px; height:54px;
    border-radius:18px;
    border:2px solid transparent;
    background: var(--chip);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    cursor:pointer;
    user-select:none;
    padding: 0 10px;
  }
  .colorChip.active{
    border-color: rgba(34,197,94,.85);
    background: rgba(34,197,94,.18);
  }
  .swatch{
    width:18px;height:18px;border-radius:6px;
    border:1px solid rgba(255,255,255,.20);
  }

  textarea.field{
    min-height: 320px;
    resize:none;
    line-height:1.35;
    padding:16px;
  }

  .buttons{
    display:flex;
    gap:14px;
    margin-top: 16px;
  }
  button{
    flex:1;
    background: rgba(30,41,59,.85);
    border: 1px solid rgba(255,255,255,.12);
    color: var(--text);
    border-radius: 18px;
    padding: 14px 12px;
    font-weight:800;
    font-size:16px;
    cursor:pointer;
  }
  button:active{transform: translateY(1px);}

  /* kleines Farbbadge links unten (Info) */
  .badge{
    position:absolute;
    left:18px; bottom:18px;
    width:18px; height:18px;
    border-radius:6px;
    background: var(--accentColor);
    opacity:.55;
    border:1px solid rgba(255,255,255,.18);
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card" id="card" style="--accentColor: var(--euroGrey);">

    <div class="topbar"></div>
    <div class="title" id="boxTitle">E000</div>
    <div class="status" id="status">Gespeichert ‚úì</div>

    <div class="row">
      <input id="ort" class="field ort" placeholder="ORT" maxlength="6" />
      <input id="bez" class="field bez" placeholder="Bezeichnung" />
    </div>

    <div class="row" style="align-items:center;">
      <div class="iconToggle" id="fragile" title="Zerbrechlich (klick)">ü•Ç</div>
      <div class="iconToggle heavy" id="heavy" title="Schwer (ab 16 kg automatisch)">üèãÔ∏è</div>

      <div class="kgWrap">
        <div class="kgBox">
          <input id="weight" class="field kgInput" inputmode="numeric" maxlength="2" placeholder="00" />
          <div class="kgSuffix">kg</div>
        </div>
      </div>
    </div>

    <!-- Farbauswahl (nur f√ºr Euroboxen; Karton = automatisch) -->
    <div id="colorRow" class="colorRow" aria-label="Farbe">
      <div class="colorChip" id="cGrey" title="Eurobox grau">
        <span class="swatch" style="background: var(--euroGrey)"></span><span>Grau</span>
      </div>
      <div class="colorChip" id="cBlack" title="Eurobox schwarz">
        <span class="swatch" style="background: var(--euroBlack)"></span><span>Schwarz</span>
      </div>
    </div>

    <textarea id="content" class="field" placeholder="‚Ä¢ Inhalt hier eintragen..."></textarea>

    <div class="buttons">
      <button id="btnBackup">Backup nach iCloud</button>
      <button id="btnImport">Backup importieren</button>
    </div>

    <div class="badge" title="Box-Farbe"></div>
  </div>
</div>

<script>
/* -------------------------
   Box-ID + Storage Keys
-------------------------- */
const qs = new URLSearchParams(location.search);
const boxId = (qs.get("box") || "E000").toUpperCase();
const storeKey = "box_" + boxId;
const metaKey  = "meta_colors"; // merkt pro Box die Eurobox-Farbe

/* -------------------------
   State
-------------------------- */
const state = {
  ort: "",
  bez: "",
  content: "",
  fragile: false,
  heavy: false,
  weight: ""
};

function $(id){ return document.getElementById(id); }

/* -------------------------
   Helpers: Bullets
-------------------------- */
function ensureStartsWithBullet(text){
  const t = (text ?? "");
  if (t.trim() === "") return "‚Ä¢ ";
  // Wenn erste nicht Bullet, vorne Bullet setzen
  if (!t.startsWith("‚Ä¢ ")) return "‚Ä¢ " + t;
  return t;
}

function insertBulletAtCursor(el){
  const start = el.selectionStart;
  const end   = el.selectionEnd;
  const before = el.value.slice(0, start);
  const after  = el.value.slice(end);
  const ins = "\n‚Ä¢ ";
  el.value = before + ins + after;
  el.selectionStart = el.selectionEnd = start + ins.length;
}

function backspaceBulletIfAtLineStart(el){
  const pos = el.selectionStart;
  if (pos !== el.selectionEnd) return false;

  const v = el.value;
  const lineStart = v.lastIndexOf("\n", pos - 1) + 1;
  // Wenn Cursor genau nach "‚Ä¢ " steht -> entferne Bullet
  const segment = v.slice(lineStart, pos);
  if (segment === "‚Ä¢ "){
    const before = v.slice(0, lineStart);
    const after  = v.slice(pos);
    el.value = before + after;
    el.selectionStart = el.selectionEnd = lineStart;
    return true;
  }
  return false;
}

/* -------------------------
   Color logic
-------------------------- */
function getMeta(){
  try { return JSON.parse(localStorage.getItem(metaKey) || "{}"); }
  catch { return {}; }
}
function setMeta(m){
  localStorage.setItem(metaKey, JSON.stringify(m));
}

function setAccentColor(hex){
  const card = $("card");
  card.style.setProperty("--accentColor", hex);
}

function applyAutoColor(){
  // Karton: automatisch
  if (boxId.startsWith("K")){
    $("colorRow").style.display = "none";
    setAccentColor(getComputedStyle(document.documentElement).getPropertyValue("--karton").trim() || "#ADAC62");
    return;
  }

  // Eurobox: gespeicherte Auswahl je Box (oder Default Grau)
  $("colorRow").style.display = "flex";

  const meta = getMeta();
  const choice = meta[storeKey]?.color || "grey";
  setEuroChoice(choice);
}

function setEuroChoice(choice){
  const meta = getMeta();
  meta[storeKey] = meta[storeKey] || {};
  meta[storeKey].color = choice;
  setMeta(meta);

  $("cGrey").classList.toggle("active", choice === "grey");
  $("cBlack").classList.toggle("active", choice === "black");

  if (choice === "black"){
    setAccentColor(getComputedStyle(document.documentElement).getPropertyValue("--euroBlack").trim() || "#0b0f19");
  } else {
    setAccentColor(getComputedStyle(document.documentElement).getPropertyValue("--euroGrey").trim() || "#C0C0C0");
  }
}

/* -------------------------
   Save/Load
-------------------------- */
function render(){
  localStorage.setItem(storeKey, JSON.stringify(state));

  $("status").textContent = "Gespeichert ‚úì";
  $("fragile").classList.toggle("active", !!state.fragile);
  $("heavy").classList.toggle("active", !!state.heavy);
}

function load(){
  $("boxTitle").textContent = boxId;

  try{
    const raw = localStorage.getItem(storeKey);
    if (raw){
      const obj = JSON.parse(raw);
      Object.assign(state, obj);
    }
  }catch{}

  $("ort").value = state.ort || "";
  $("bez").value = state.bez || "";

  // Inhalt: Bullet-Start erzwingen, damit "jede Eingabe Bullet" passt
  state.content = ensureStartsWithBullet(state.content || "");
  $("content").value = state.content;

  $("weight").value = (state.weight ?? "").toString().replace(/\D/g,"").slice(0,2);

  // Heavy ab 16 kg automatisch aus Gewicht
  const w = parseInt($("weight").value || "0", 10);
  state.heavy = w >= 16;

  applyAutoColor();
  render();
}

/* -------------------------
   Events
-------------------------- */
$("ort").addEventListener("input", (e)=>{ state.ort = e.target.value.toUpperCase().slice(0,6); render(); });
$("bez").addEventListener("input", (e)=>{ state.bez = e.target.value; render(); });

$("fragile").addEventListener("click", ()=>{
  state.fragile = !state.fragile;
  render();
});

// Heavy: Klick toggelt nur, wenn kein Gewicht gesetzt ist.
// Sonst regelt Gewicht (ab 16kg).
$("heavy").addEventListener("click", ()=>{
  const w = parseInt($("weight").value || "0", 10);
  if (w > 0){
    // Gewicht hat Vorrang
    state.heavy = w >= 16;
  } else {
    state.heavy = !state.heavy;
  }
  render();
});

$("weight").addEventListener("input", (e)=>{
  const digits = (e.target.value || "").replace(/\D/g,"").slice(0,2);
  e.target.value = digits;
  state.weight = digits;
  const w = parseInt(digits || "0", 10);
  state.heavy = w >= 16;
  render();
});

$("content").addEventListener("focus", (e)=>{
  if (!e.target.value || e.target.value.trim()===""){
    e.target.value = "‚Ä¢ ";
    state.content = e.target.value;
    render();
  }
});

$("content").addEventListener("keydown", (e)=>{
  if (e.key === "Enter"){
    e.preventDefault();
    insertBulletAtCursor(e.target);
    state.content = e.target.value;
    render();
    return;
  }
  if (e.key === "Backspace"){
    // Bullet am Zeilenanfang entfernen
    if (backspaceBulletIfAtLineStart(e.target)){
      e.preventDefault();
      state.content = e.target.value;
      render();
    }
  }
});

$("content").addEventListener("input", (e)=>{
  state.content = e.target.value;
  render();
});

$("cGrey").addEventListener("click", ()=> setEuroChoice("grey"));
$("cBlack").addEventListener("click", ()=> setEuroChoice("black"));

/* -------------------------
   Backup Export/Import (funktional)
-------------------------- */
function collectAllBoxData(){
  const out = {};
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if (!k) continue;
    if (k.startsWith("box_") || k === metaKey){
      out[k] = localStorage.getItem(k);
    }
  }
  return out;
}

$("btnBackup").addEventListener("click", ()=>{
  const payload = collectAllBoxData();
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Euroboxen_Backup.json";
  a.click();
});

$("btnImport").addEventListener("click", ()=>{
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json,.json";
  inp.onchange = async ()=>{
    const file = inp.files?.[0];
    if (!file) return;
    const text = await file.text();
    let data;
    try{ data = JSON.parse(text); }catch{ alert("Backup-Datei ist kein g√ºltiges JSON."); return; }

    // nur erwartete Keys importieren
    Object.keys(data).forEach(k=>{
      if (k.startsWith("box_") || k === metaKey){
        localStorage.setItem(k, data[k]);
      }
    });

    location.reload();
  };
  inp.click();
});

/* -------------------------
   Init
-------------------------- */
load();
</script>
</body>
</html>
