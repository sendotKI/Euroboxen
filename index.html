<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Eurobox</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0b1220;
  --card:#151c2f;
  --border:#2a3555;
  --text:#ffffff;
  --muted:#9aa3b2;
  --ok:#35d07f;
  --red:#ff4d4d;
  --grey:#C0C0C0;
  --black:#000000;
}

body{
  margin:0;
  background:linear-gradient(180deg,#050810,#0b1220);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  color:var(--text);
}

.container{
  max-width:480px;
  margin:20px auto;
  padding:20px;
}

.card{
  background:var(--card);
  border-radius:20px;
  padding:20px;
  box-shadow:0 0 40px rgba(0,0,0,.6);
  transition:.2s;
}

h1{
  text-align:center;
  margin:0;
  font-size:36px;
  letter-spacing:2px;
}

.status{
  text-align:center;
  color:var(--ok);
  margin-top:6px;
  min-height:20px;
}

.row{
  display:flex;
  gap:10px;
  margin-top:16px;
}

.row.colors{
  margin-bottom:24px; /* Abstand zum Inhaltsfeld */
}

input,textarea{
  background:#0f172a;
  border:1px solid var(--border);
  border-radius:14px;
  color:#fff;
  padding:12px;
  font-size:16px;
  width:100%;
}

textarea{
  height:180px;
  resize:none;
}

.icon{
  width:56px;
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  border-radius:16px;
  border:2px solid var(--border);
  cursor:pointer;
  transition:.15s;
  user-select:none;
}

.icon.active{
  border-color:var(--ok);
  box-shadow:0 0 12px rgba(53,208,127,.6);
}

.icon.heavy.active{
  border-color:var(--red);
  box-shadow:0 0 14px rgba(255,77,77,.7);
}

/* Farbauswahl ‚Äì 50% kleiner */
.icon.color{
  width:28px;
  height:28px;
  border-radius:8px;
}

.icon.color.active{
  outline:2px solid var(--ok);
}

.weightBox{
  width:90px;
  text-align:center;
  font-weight:700;
}

.buttons{
  display:flex;
  gap:10px;
  margin-top:20px;
}

button{
  flex:1;
  padding:12px;
  border-radius:14px;
  border:none;
  background:#1f2a4d;
  color:#fff;
  font-size:14px;
  cursor:pointer;
}

button:active{
  transform:scale(0.99);
}
</style>
</head>

<body>
<div class="container">
  <div class="card" id="card">

    <h1 id="boxId">E000</h1>
    <div class="status" id="status">Gespeichert ‚úì</div>

    <div class="row">
      <input id="ort" maxlength="6" placeholder="ORT">
      <input id="bez" placeholder="Bezeichnung">
    </div>

    <div class="row">
      <div class="icon" id="fragile" title="Zerbrechlich">üç∑</div>
      <div class="icon heavy" id="heavy" title="Schwer (ab 16 kg)">üèãÔ∏è</div>
      <input id="kg" class="weightBox" type="number" min="0" max="99" placeholder="00 kg">
    </div>

    <div class="row colors">
      <div class="icon color" id="black" title="Schwarze Box" style="background:#000"></div>
      <div class="icon color active" id="grey" title="Graue Box" style="background:#C0C0C0"></div>
    </div>

    <textarea id="content" placeholder="‚Ä¢ Inhalt hier eintragen‚Ä¶"></textarea>

    <div class="buttons">
      <button id="btnBackup">Backup nach iCloud</button>
      <button id="btnImport">Backup importieren</button>
    </div>

    <!-- unsichtbare Dateiauswahl -->
    <input id="filePicker" type="file" accept="application/json" style="display:none" />

  </div>
</div>

<script>
const $ = id => document.getElementById(id);

const boxId = new URLSearchParams(location.search).get("box") || "E000";
$("boxId").textContent = boxId;

/* =========================
   Speicherformat (localStorage)
   key: euroboxen_v1  (Objekt mit E001..)
   value:
   {
     "E001": { ort, bez, content, fragile, heavy, kg, color, updatedAt },
     ...
   }
========================= */
const STORAGE_KEY = "euroboxen_v1";

function nowIso(){
  return new Date().toISOString();
}

function loadAll(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}") || {};
  }catch(e){
    return {};
  }
}

function saveAll(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}

function setStatus(text, ok=true){
  const el = $("status");
  el.style.color = ok ? "var(--ok)" : "var(--red)";
  el.textContent = text;
}

function defaultBox(){
  return {
    ort:"",
    bez:"",
    content:"‚Ä¢ ",
    fragile:false,
    heavy:false,
    kg:0,
    color:"grey",
    updatedAt: nowIso()
  };
}

function getBoxData(){
  const all = loadAll();
  return all[boxId] ? all[boxId] : defaultBox();
}

function putBoxData(data){
  const all = loadAll();
  all[boxId] = data;
  saveAll(all);
}

/* =========================
   UI + State
========================= */
let state = getBoxData();

// Init UI
$("ort").value = state.ort || "";
$("bez").value = state.bez || "";
$("content").value = (state.content && state.content.trim().length) ? state.content : "‚Ä¢ ";
$("kg").value = (state.kg ?? 0) ? String(state.kg) : "";

$("fragile").classList.toggle("active", !!state.fragile);
$("heavy").classList.toggle("active", !!state.heavy);
setColor(state.color || "grey", false);

function setColor(c, persist=true){
  state.color = c;
  $("black").classList.toggle("active", c==="black");
  $("grey").classList.toggle("active", c==="grey");

  // Hintergrund der Karte: schwarz = #000, grau = #C0C0C0
  $("card").style.background = (c==="black") ? "#000000" : "#C0C0C0";

  // Textkontrast bei grauer Karte bleibt gut, weil Inputs dunkel sind.
  if(persist) saveAndStatus();
}

// Click-Icons
$("fragile").onclick = () => {
  state.fragile = !state.fragile;
  $("fragile").classList.toggle("active", state.fragile);
  saveAndStatus();
};

$("black").onclick = () => setColor("black");
$("grey").onclick  = () => setColor("grey");

// Gewicht: Heavy ab 16 kg
$("kg").addEventListener("input",()=>{
  const v = parseInt($("kg").value || "0", 10);
  state.kg = isNaN(v) ? 0 : Math.max(0, Math.min(99, v));
  state.heavy = state.kg >= 16;
  $("heavy").classList.toggle("active", state.heavy);
  saveAndStatus();
});

// Heavy-Icon weiterhin anklickbar (override m√∂glich)
$("heavy").onclick = () => {
  // Toggle manuell; wenn Gewicht >=16 bleibt standardm√§√üig an, aber du kannst es bewusst ausmachen.
  state.heavy = !state.heavy;
  $("heavy").classList.toggle("active", state.heavy);
  saveAndStatus();
};

// Ort/Bezeichnung/Content speichern
["ort","bez"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    state[id] = $(id).value;
    saveAndStatus();
  });
});

// Aufz√§hlung: Enter => neue Zeile mit ‚Ä¢ ; Backspace am Zeilenanfang entfernt Bullet
$("content").addEventListener("keydown",e=>{
  const ta = $("content");
  const v = ta.value;

  if(e.key === "Enter"){
    e.preventDefault();
    insertAtCursor(ta, "\n‚Ä¢ ");
    return;
  }

  if(e.key === "Backspace"){
    // Wenn Cursor direkt nach "\n‚Ä¢ " steht, entferne diese 3 Zeichen
    const pos = ta.selectionStart;
    if(pos >= 3 && v.slice(pos-3, pos) === "\n‚Ä¢ "){
      e.preventDefault();
      ta.value = v.slice(0, pos-3) + v.slice(pos);
      ta.selectionStart = ta.selectionEnd = pos-3;
      state.content = ta.value;
      saveAndStatus();
    }
  }
});

$("content").addEventListener("input", ()=>{
  state.content = $("content").value;
  saveAndStatus();
});

function insertAtCursor(el, text){
  const start = el.selectionStart;
  const end = el.selectionEnd;
  const v = el.value;
  el.value = v.slice(0,start) + text + v.slice(end);
  el.selectionStart = el.selectionEnd = start + text.length;
  state.content = el.value;
  saveAndStatus();
}

let saveTimer = null;
function saveAndStatus(){
  clearTimeout(saveTimer);
  setStatus("Speichert‚Ä¶", true);

  saveTimer = setTimeout(()=>{
    state.updatedAt = nowIso();
    putBoxData(state);
    setStatus("Gespeichert ‚úì", true);
  }, 300);
}

/* =========================
   BACKUP EXPORT (Download)
========================= */
function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}

$("btnBackup").addEventListener("click", ()=>{
  // Alles sichern
  const all = loadAll();
  const payload = {
    meta: {
      app: "Euroboxen",
      version: 1,
      exportedAt: nowIso()
    },
    data: all
  };
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const fn = `Euroboxen_Backup_${yyyy}-${mm}-${dd}.json`;

  downloadJson(fn, payload);
  setStatus("Backup erstellt ‚úì", true);
});

/* =========================
   BACKUP IMPORT
========================= */
$("btnImport").addEventListener("click", ()=>{
  $("filePicker").value = "";
  $("filePicker").click();
});

$("filePicker").addEventListener("change", async ()=>{
  const file = $("filePicker").files && $("filePicker").files[0];
  if(!file) return;

  try{
    const txt = await file.text();
    const parsed = JSON.parse(txt);

    // Akzeptiere:
    // (A) { meta, data }
    // (B) direktes Objekt { "E001": {...}, ... }
    let incoming = null;

    if(parsed && typeof parsed === "object" && parsed.data && typeof parsed.data === "object"){
      incoming = parsed.data;
    }else if(parsed && typeof parsed === "object"){
      incoming = parsed;
    }

    if(!incoming || typeof incoming !== "object"){
      throw new Error("Ung√ºltiges Format");
    }

    // Merge: vorhandene Daten √ºberschreiben durch Import
    const current = loadAll();
    const merged = { ...current, ...incoming };
    saveAll(merged);

    // Aktuelle Box neu laden
    state = merged[boxId] ? merged[boxId] : defaultBox();

    $("ort").value = state.ort || "";
    $("bez").value = state.bez || "";
    $("content").value = (state.content && state.content.trim().length) ? state.content : "‚Ä¢ ";
    $("kg").value = (state.kg ?? 0) ? String(state.kg) : "";

    $("fragile").classList.toggle("active", !!state.fragile);
    $("heavy").classList.toggle("active", !!state.heavy);
    setColor(state.color || "grey", false);

    setStatus("Import OK ‚úì", true);

  }catch(err){
    setStatus("Import fehlgeschlagen ‚úó", false);
  }
});

// initial speichern wenn leer
if(!state.content || !state.content.trim().length){
  state.content = "‚Ä¢ ";
  putBoxData(state);
}
</script>

</body>
</html>
