<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Euroboxen</title>

  <style>
    :root{
      --page:#071225;

      --eGrey:#2b3447;
      --eBlack:#000000;

      --kCard:#ADAC62;
      --tCard:#9FFCFD;

      --ok:#27d17e;
      --text:#e9eef7;

      --stroke:rgba(255,255,255,.14);
      --tileBg:rgba(0,0,0,.18);

      --glowGreen:rgba(39,209,126,.55);
      --glowRed:rgba(255,80,80,.55);

      --radius:26px;
      --tileRadius:18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px 12px;
      background:var(--page);
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
    }

    .card{
      width:min(520px, 92vw);
      border-radius:var(--radius);
      padding:16px 16px 14px;
      background:var(--eGrey);
      box-shadow:0 26px 70px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
    }

    .topbar{
      height:10px;
      width:92%;
      margin:4px auto 10px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
    }

    /* ===== Titel kleiner ===== */
    .title{
      margin:0;
      text-align:center;
      font-size:40px;          /* vorher 44 */
      font-weight:900;
      letter-spacing:1px;
      line-height:1.0;
    }
    .status{
      margin-top:6px;
      text-align:center;
      font-size:20px;
      font-weight:900;
      color:var(--ok);
    }

    /* ===== Zeilen ===== */
    .row2{
      display:flex;
      gap:12px;                /* etwas enger */
      margin-top:14px;
      width:100%;
    }
    .row2 > *{
      flex:1;
      min-width:0;
    }

    .rowIcons{
      display:flex;
      gap:12px;                /* etwas enger */
      margin-top:12px;
      width:100%;
      align-items:stretch;
    }

    /* ===== Inputs ===== */
    .input{
      height:58px;             /* etwas kleiner */
      border-radius:var(--tileRadius);
      border:2px solid var(--stroke);
      background:var(--tileBg);
      color:var(--text);
      font-size:22px;
      font-weight:800;
      padding:0 14px;
      outline:none;
      width:100%;
      min-width:0;
    }
    .input::placeholder{
      color:rgba(233,238,247,.45);
      font-weight:900;
    }

    /* Wichtig: Text darf nicht "komisch" abgeschnitten wirken */
    #bez{
      font-size:21px;          /* minimal kleiner -> mehr Zeichen sichtbar */
      letter-spacing:.2px;
    }

    /* ===== Tiles ===== */
    .tile{
      height:68px;             /* vorher 72 -> kompakter wie E022 */
      border-radius:var(--tileRadius);
      border:2px solid var(--stroke);
      background:var(--tileBg);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      width:100%;
    }
    .tile.btn{ cursor:pointer; }

    .tile.active.fragile{ box-shadow:0 0 0 4px var(--glowGreen); }
    .tile.active.heavy{ box-shadow:0 0 0 4px var(--glowRed); }

    .iconTile{
      width:70px;
      flex:0 0 70px;           /* vorher 74 */
      font-size:30px;
    }

    /* ===== KG Tile (schlanker & sch√∂ner) ===== */
    .kgTile{
      flex:1;
      min-width:0;
      justify-content:center;
      gap:10px;
      padding:0 14px;
      cursor:text;
    }
    .kgTile input{
      flex:1;
      min-width:0;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:38px;          /* etwas kleiner */
      font-weight:900;
      letter-spacing:1px;
      text-align:right;        /* wirkt wie im Beispiel: Zahl rechts ‚Äûsauber‚Äú */
      padding:0;
    }
    .kgTile .unit{
      font-size:28px;          /* kg nicht riesig */
      font-weight:900;
      opacity:.92;
      white-space:nowrap;
    }

    /* Farbauswahl nur E */
    .colorRow{
      display:flex;
      gap:12px;
      margin-top:10px;
      margin-bottom:16px;      /* Abstand zum Inhaltsfeld */
      align-items:center;
    }
    .colorBox{
      width:30px;
      height:30px;
      border-radius:10px;
      border:2px solid var(--stroke);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      background:rgba(0,0,0,.25);
    }
    .colorBox.black{ background:#000; }
    .colorBox.grey{ background:#c0c0c0; }
    .colorBox.active{ box-shadow:0 0 0 4px var(--glowGreen); }

    /* ===== Inhalt ===== */
    .contentWrap{
      border-radius:22px;
      border:2px solid var(--stroke);
      background:var(--tileBg);
      padding:12px;
      margin-top:14px;         /* Abstand zur Icon-Zeile (wieder sichtbar) */
    }
    textarea{
      width:100%;
      height:320px;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:22px;
      resize:none;
    }
    textarea::placeholder{
      color:rgba(233,238,247,.45);
      font-weight:900;
    }

    /* ===== Buttons ===== */
    .btnRow{
      display:flex;
      gap:14px;
      margin-top:14px;
    }
    button{
      flex:1;
      height:72px;
      border-radius:18px;
      border:none;
      background:#263a5f;
      color:#fff;
      font-size:22px;
      font-weight:900;
    }

    /* ===== Modes ===== */
    .mode-eblack{ background:var(--eBlack); }
    .mode-egrey{ background:var(--eGrey); }

    .mode-k{ background:var(--kCard); color:#111; }
    .mode-t{ background:var(--tCard); color:#111; }

    .mode-k .topbar, .mode-t .topbar{ background:rgba(0,0,0,.12); }

    .mode-k .input, .mode-k .tile, .mode-k .contentWrap,
    .mode-t .input, .mode-t .tile, .mode-t .contentWrap{
      background:rgba(255,255,255,.30);
      border-color:rgba(0,0,0,.22);
      color:#111;
    }
    .mode-k textarea, .mode-k .kgTile input,
    .mode-t textarea, .mode-t .kgTile input{
      color:#111;
    }
    .mode-k .input::placeholder, .mode-k textarea::placeholder,
    .mode-t .input::placeholder, .mode-t textarea::placeholder{
      color:rgba(0,0,0,.35);
    }

    /* iPhone klein */
    @media (max-width: 380px){
      .title{ font-size:36px; }
      .status{ font-size:18px; }
      .input{ height:56px; }
      .iconTile{ width:66px; flex-basis:66px; }
      .tile{ height:66px; }
      .kgTile input{ font-size:36px; }
      .kgTile .unit{ font-size:26px; }
    }
  </style>
</head>

<body>
  <div class="card mode-egrey" id="card">
    <div class="topbar"></div>

    <h1 class="title" id="boxId">E001</h1>
    <div class="status" id="status">Gespeichert ‚úì</div>

    <div class="row2">
      <input id="ort" class="input" placeholder="ORT" maxlength="6" />
      <input id="bez" class="input" placeholder="Bezeichnung" />
    </div>

    <div class="rowIcons">
      <div id="fragile" class="tile btn iconTile fragile" title="Zerbrechlich">üç∑</div>
      <div id="heavy" class="tile btn iconTile heavy" title="Heavy">üèãÔ∏è</div>

      <div id="kgTile" class="tile kgTile" title="Gewicht">
        <input id="kg" inputmode="numeric" pattern="[0-9]*" maxlength="2" value="00" />
        <span class="unit">kg</span>
      </div>
    </div>

    <div class="colorRow" id="colorRow">
      <div id="cGrey" class="colorBox grey" title="Grau"></div>
      <div id="cBlack" class="colorBox black" title="Schwarz"></div>
    </div>

    <div class="contentWrap">
      <textarea id="content" placeholder="‚Ä¢ Inhalt hier eintragen..."></textarea>
    </div>

    <div class="btnRow">
      <button id="backupBtn">Backup nach iCloud</button>
      <button id="importBtn">Backup importieren</button>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const card = $("card");
  const statusEl = $("status");

  const params = new URLSearchParams(location.search);
  const boxId = (params.get("box") || "E001").toUpperCase();
  $("boxId").textContent = boxId;

  const colorRow = $("colorRow");
  const fragileBtn = $("fragile");
  const heavyBtn = $("heavy");
  const kgTile = $("kgTile");
  const kgInput = $("kg");

  let saveTimer = null;

  function setStatusSaving(){ statusEl.textContent = "Speichert‚Ä¶"; }
  function setStatusSaved(){ statusEl.textContent = "Gespeichert ‚úì"; }

  function getStore(){
    try { return JSON.parse(localStorage.getItem("euroboxen") || "{}"); }
    catch { return {}; }
  }
  function setStore(obj){
    localStorage.setItem("euroboxen", JSON.stringify(obj));
  }

  function scheduleSave(){
    setStatusSaving();
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      saveBox();
      setStatusSaved();
    }, 220);
  }

  function applyMode(mode){
    card.className = "card " + mode;
  }

  function initMode(){
    if (boxId.startsWith("K")){
      applyMode("mode-k");
      colorRow.style.display = "none";
    } else if (boxId.startsWith("T")){
      applyMode("mode-t");
      colorRow.style.display = "none";
    } else {
      applyMode("mode-egrey");
      colorRow.style.display = "flex";
    }
  }
  initMode();

  function setEuroColor(color, doSave=true){
    if (boxId.startsWith("K") || boxId.startsWith("T")) return;

    $("cGrey").classList.toggle("active", color==="grey");
    $("cBlack").classList.toggle("active", color==="black");

    applyMode(color==="black" ? "mode-eblack" : "mode-egrey");
    if (doSave) scheduleSave();
  }

  $("cGrey").addEventListener("click", ()=>setEuroColor("grey"));
  $("cBlack").addEventListener("click", ()=>setEuroColor("black"));

  function computeHeavyActive(kg, heavyManual){
    return (kg >= 16) || !!heavyManual;
  }

  function normalizeKgOnBlur(){
    let s = (kgInput.value || "").replace(/\D/g,"").slice(0,2);
    if (s.length===0) s="00";
    if (s.length===1) s="0"+s;
    kgInput.value = s;
  }

  function loadBox(){
    const db = getStore();
    const v = db[boxId] || {};

    $("ort").value = v.ort || "";
    $("bez").value = v.bez || "";
    $("content").value = v.content || "";

    fragileBtn.classList.toggle("active", !!v.fragile);

    kgInput.value = (v.kg ?? "00").toString().replace(/\D/g,"").slice(0,2) || "00";
    normalizeKgOnBlur();

    const kg = parseInt(kgInput.value, 10) || 0;
    const heavyActive = computeHeavyActive(kg, v.heavyManual);
    heavyBtn.classList.toggle("active", heavyActive);

    if (!boxId.startsWith("K") && !boxId.startsWith("T")){
      setEuroColor(v.color || "grey", false);
    }

    setStatusSaved();
  }

  function saveBox(){
    const db = getStore();
    db[boxId] = db[boxId] || {};
    const v = db[boxId];

    v.ort = $("ort").value.trim();
    v.bez = $("bez").value.trim();
    v.content = $("content").value;

    v.fragile = fragileBtn.classList.contains("active");
    v.kg = kgInput.value;

    if (!boxId.startsWith("K") && !boxId.startsWith("T")){
      v.color = card.classList.contains("mode-eblack") ? "black" : "grey";
    }

    setStore(db);
  }

  loadBox();

  fragileBtn.addEventListener("click",(e)=>{
    e.preventDefault(); e.stopPropagation();
    fragileBtn.classList.toggle("active");
    scheduleSave();
  });

  heavyBtn.addEventListener("click",(e)=>{
    e.preventDefault(); e.stopPropagation();
    const db = getStore();
    db[boxId] = db[boxId] || {};
    db[boxId].heavyManual = !db[boxId].heavyManual;
    setStore(db);

    const kg = parseInt(kgInput.value,10) || 0;
    heavyBtn.classList.toggle("active", computeHeavyActive(kg, db[boxId].heavyManual));
    scheduleSave();
  });

  function focusKgAll(){
    kgInput.focus({preventScroll:true});
    try { kgInput.setSelectionRange(0, kgInput.value.length); } catch {}
  }

  kgTile.addEventListener("click",(e)=>{
    e.preventDefault(); e.stopPropagation();
    focusKgAll();
  });

  kgInput.addEventListener("focus", ()=>setTimeout(focusKgAll,0));

  kgInput.addEventListener("input", ()=>{
    kgInput.value = (kgInput.value || "").replace(/\D/g,"").slice(0,2);

    const kg = parseInt(kgInput.value || "0", 10) || 0;
    const db = getStore();
    const manual = !!(db[boxId] && db[boxId].heavyManual);
    heavyBtn.classList.toggle("active", computeHeavyActive(kg, manual));

    scheduleSave();
  });

  kgInput.addEventListener("blur", ()=>{
    normalizeKgOnBlur();
    const kg = parseInt(kgInput.value, 10) || 0;
    const db = getStore();
    const manual = !!(db[boxId] && db[boxId].heavyManual);
    heavyBtn.classList.toggle("active", computeHeavyActive(kg, manual));
    scheduleSave();
  });

  $("ort").addEventListener("input", scheduleSave);
  $("bez").addEventListener("input", scheduleSave);

  const content = $("content");

  content.addEventListener("focus", ()=>{
    if (content.value.trim()===""){
      content.value = "‚Ä¢ ";
      setTimeout(()=>content.setSelectionRange(content.value.length, content.value.length),0);
    }
  });

  content.addEventListener("keydown", (e)=>{
    if(e.key==="Backspace"){
      const pos = content.selectionStart;
      const before = content.value.slice(0,pos);
      const lineStart = before.lastIndexOf("\n")+1;
      const line = before.slice(lineStart);
      if(line === "‚Ä¢ "){
        e.preventDefault();
        const after = content.value.slice(pos);
        content.value = content.value.slice(0,lineStart) + after;
        content.setSelectionRange(lineStart,lineStart);
        scheduleSave();
      }
    }
    if(e.key==="Enter"){
      e.preventDefault();
      const pos = content.selectionStart;
      const left = content.value.slice(0,pos);
      const right = content.value.slice(pos);
      content.value = left + "\n‚Ä¢ " + right;
      const np = pos + 3;
      content.setSelectionRange(np,np);
      scheduleSave();
    }
  });

  content.addEventListener("input", scheduleSave);

  $("backupBtn").addEventListener("click", async ()=>{
    const data = getStore();
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const file = new File([blob], "euroboxen.json", {type:"application/json"});

    if (navigator.canShare && navigator.canShare({files:[file]})) {
      try { await navigator.share({files:[file], title:"Euroboxen Backup"}); return; }
      catch {}
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "euroboxen.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("importBtn").addEventListener("click", ()=>{
    const inp = document.createElement("input");
    inp.type="file";
    inp.accept="application/json";
    inp.onchange = async ()=>{
      const f = inp.files?.[0];
      if(!f) return;
      const txt = await f.text();
      let incoming = {};
      try { incoming = JSON.parse(txt); } catch { return; }

      const db = getStore();
      for(const k of Object.keys(incoming)){
        db[k] = incoming[k];
      }
      setStore(db);
      loadBox();
    };
    inp.click();
  });
</script>
</body>
</html>
