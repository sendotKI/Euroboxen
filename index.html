<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Euroboxen</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    .card { background:#fff; max-width:720px; margin:0 auto; border-radius:14px; padding:22px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
    h1 { margin:0 0 8px 0; font-size:26px; }
    .muted { color:#666; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; background:#eee; margin:6px 0 14px 0; }
    .ok { background:#e7f7ee; color:#146c2e; }
    .bad { background:#fdecec; color:#8a1f1f; }
    .row { margin:14px 0; }
    .label { font-weight:bold; margin-bottom:6px; display:block; }
    textarea { width:100%; min-height:180px; font-size:16px; padding:12px; border-radius:10px; border:1px solid #ddd; resize:vertical; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    button:hover { background:#fafafa; }
    .small { font-size:12px; color:#777; margin-top:10px; }
    code { background:#f0f0f0; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üì¶ Eurobox</h1>
    <div id="status" class="pill">Lade‚Ä¶</div>
    <div class="row">
      <span class="label">Box-ID:</span>
      <div id="boxId" class="muted">‚Äì</div>
    </div>

    <div class="row">
      <span class="label">Inhalt:</span>
      <textarea id="content" placeholder="Kein Zugriff / kein Inhalt" readonly></textarea>
      <div class="actions">
        <button id="copyBtn" type="button">Inhalt kopieren</button>
        <button id="reloadBtn" type="button">Neu laden</button>
      </div>
      <div class="small">
        Aufruf-Format: <code>?box=E001&k=SCHLUESSEL</code>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function qp(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || "";
    }

    function setStatus(ok, text) {
      const el = $("status");
      el.textContent = text;
      el.className = "pill " + (ok ? "ok" : "bad");
    }

    async function load() {
      const box = qp("box").trim();
      const key = qp("k").trim();

      $("boxId").textContent = box || "‚Äì";
      $("content").value = "";
      setStatus(false, "Lade‚Ä¶");

      if (!box) {
        setStatus(false, "Kein Zugriff (Box fehlt)");
        $("content").value = "‚ùå Bitte QR-Link mit Box-ID √∂ffnen, z.B. ?box=E001&k=‚Ä¶";
        return;
      }
      if (!key) {
        setStatus(false, "Kein Zugriff (Schl√ºssel fehlt)");
        $("content").value = "‚ùå Schl√ºssel fehlt.\n\nDer QR-Code muss so aussehen:\n?box=" + box + "&k=DEINSCHLUESSEL";
        return;
      }

      try {
        // Cache-Buster, damit Updates an boxes.json sofort sichtbar sind
        const res = await fetch("boxes.json?v=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("boxes.json nicht gefunden (HTTP " + res.status + ")");
        const data = await res.json();

        if (!data[box]) {
          setStatus(false, "Kein Zugriff (unbekannte Box)");
          $("content").value = "‚ùå Diese Box-ID existiert nicht in boxes.json:\n" + box;
          return;
        }

        const expected = (data[box].key || "").trim();
        if (key !== expected) {
          setStatus(false, "Kein Zugriff (falscher Schl√ºssel)");
          $("content").value = "‚ùå Falscher Schl√ºssel.\n\nHinweis: Ohne korrekten Schl√ºssel wird der Inhalt NICHT angezeigt.";
          return;
        }

        setStatus(true, "Zugriff OK");
        $("content").value = (data[box].content || "").trim() || "‚Äî (kein Inhalt hinterlegt) ‚Äî";
      } catch (e) {
        setStatus(false, "Fehler");
        $("content").value = "‚ùå Fehler beim Laden:\n" + e.message + "\n\nPr√ºfe:\n- Liegt boxes.json im selben Ordner wie index.html?\n- Ist es g√ºltiges JSON?";
      }
    }

    $("copyBtn").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText($("content").value);
        alert("‚úÖ Inhalt kopiert");
      } catch {
        alert("‚ùå Kopieren nicht m√∂glich (Browser-Berechtigung). Markiere den Text manuell.");
      }
    });

    $("reloadBtn").addEventListener("click", load);

    load();
  </script>
</body>
</html>
