<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Suche</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --bg:#0b1220;
  --card:#151c2f;
  --border:#2a3555;
  --text:#ffffff;
  --muted:#9aa3b2;
  --ok:#35d07f;
  --red:#ff4d4d;
}

body{
  margin:0;
  background:linear-gradient(180deg,#050810,#0b1220);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  color:var(--text);
}

.container{
  max-width:520px;
  margin:20px auto;
  padding:20px;
}

h1{
  margin:0 0 14px 0;
  font-size:38px;
  font-weight:800;
}

.searchBox{
  width:100%;
  background:#0f172a;
  border:1px solid var(--border);
  border-radius:16px;
  color:#fff;
  padding:14px 14px;
  font-size:16px;
  outline:none;
}

.row{
  display:flex;
  gap:10px;
  margin-top:12px;
  flex-wrap:wrap;
}

button{
  padding:12px 14px;
  border-radius:16px;
  border:none;
  background:#1f2a4d;
  color:#fff;
  font-size:14px;
  cursor:pointer;
}
button:active{ transform:scale(0.99); }

.pills{
  display:flex;
  gap:10px;
  margin-top:14px;
  align-items:center;
}

.pill{
  width:50px;
  height:50px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:999px;
  border:2px solid var(--border);
  background:rgba(255,255,255,0.03);
  cursor:pointer;
  user-select:none;
  font-size:22px;
  transition:.15s;
}
.pill.active{
  border-color:var(--ok);
  box-shadow:0 0 12px rgba(53,208,127,.6);
}

.count{
  margin-top:10px;
  color:var(--muted);
}

.list{
  margin-top:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.item{
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.07);
  border-radius:18px;
  padding:14px;
  display:flex;
  gap:12px;
  align-items:center;
}

.badges{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:60px;
  align-items:flex-start;
}

.badgeColor{
  width:26px;
  height:18px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.18);
}

.badgeTiny{
  width:42px;
  height:34px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}

.main{
  flex:1;
  min-width:0;
}

.titleLine{
  display:flex;
  gap:10px;
  align-items:baseline;
}
.code{
  font-size:28px;
  font-weight:900;
  letter-spacing:1px;
}
.name{
  font-size:22px;
  font-weight:700;
  opacity:.95;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.sub{
  margin-top:4px;
  color:var(--muted);
  font-size:13px;
}

.preview{
  margin-top:8px;
  font-size:15px;
  opacity:.95;
  line-height:1.25;
  max-height:3.9em;
  overflow:hidden;
}

.openBtn{
  flex:0 0 auto;
  padding:12px 14px;
  border-radius:16px;
  background:#1f2a4d;
  border:1px solid rgba(255,255,255,0.12);
  font-weight:700;
  min-width:92px;      /* <-- verhindert "√ñffn‚Ä¶" */
  text-align:center;
}
</style>
</head>
<body>

<div class="container">
  <h1>Suche</h1>

  <input id="q" class="searchBox" placeholder="Suche nach Ort, Bezeichnung, Inhalt, kg‚Ä¶ (z. B. E022, K√ºche, 16, Hobby)">

  <div class="row">
    <button id="reload">Neu einlesen</button>
    <button id="clear">Leeren</button>
  </div>

  <div class="pills">
    <div class="pill" id="fFragile" title="Zerbrechlich">üç∑</div>
    <div class="pill" id="fHeavy" title="Schwer">üèãÔ∏è</div>
    <div class="pill" id="fBlack" title="Schwarz" style="font-size:0;">
      <span class="badgeColor" style="background:#000; width:26px; height:26px; border-radius:8px;"></span>
    </div>
    <div class="pill" id="fGrey" title="Grau" style="font-size:0;">
      <span class="badgeColor" style="background:#C0C0C0; width:26px; height:26px; border-radius:8px;"></span>
    </div>
  </div>

  <div class="count" id="count">Gefunden: 0</div>

  <div class="list" id="list"></div>
</div>

<script>
const STORAGE_KEY = "euroboxen_v1"; // muss zu index.html passen!

const $ = id => document.getElementById(id);

let all = {};
let filters = { fragile:false, heavy:false, black:false, grey:false };

function loadAll(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}") || {};
  }catch(e){
    return {};
  }
}

function saveAll(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}

function normalize(s){
  return (s||"").toString().toLowerCase().trim();
}

function boxMatches(id, b, query){
  const q = normalize(query);

  // Filterchips
  if(filters.fragile && !b.fragile) return false;
  if(filters.heavy && !b.heavy) return false;
  if(filters.black && (b.color !== "black")) return false;
  if(filters.grey && (b.color !== "grey")) return false;

  if(!q) return true;

  const hay = [
    id,
    b.ort || "",
    b.bez || "",
    (b.content || "").replace(/\n/g," "),
    (b.kg ?? "").toString()
  ].join(" | ").toLowerCase();

  return hay.includes(q);
}

function formatLocal(ts){
  if(!ts) return "";
  try{
    const d = new Date(ts);
    // deutsches Format ohne Sekunden reicht
    return d.toLocaleString("de-DE");
  }catch(e){
    return "";
  }
}

function contentPreview(text){
  const t = (text || "").trim();
  if(!t) return "‚Ä¢";
  // zeige max 3 Zeilen
  const lines = t.split("\n").slice(0,3).map(x=>x.trim()).filter(Boolean);
  return lines.join("\n");
}

function render(){
  const q = $("q").value;
  const list = $("list");
  list.innerHTML = "";

  const ids = Object.keys(all).sort(); // Reihenfolge E001..E200
  const results = [];

  for(const id of ids){
    const b = all[id] || {};
    if(boxMatches(id,b,q)) results.push([id,b]);
  }

  $("count").textContent = `Gefunden: ${results.length} / ${ids.length} (nur dieses Ger√§t)`;

  for(const [id,b] of results){
    const item = document.createElement("div");
    item.className = "item";

    const badges = document.createElement("div");
    badges.className = "badges";

    const color = document.createElement("div");
    color.className = "badgeColor";
    color.style.background = (b.color === "black") ? "#000" : "#C0C0C0";
    badges.appendChild(color);

    const rowIcons = document.createElement("div");
    rowIcons.style.display = "flex";
    rowIcons.style.gap = "8px";

    const kgBadge = document.createElement("div");
    kgBadge.className = "badgeTiny";
    kgBadge.textContent = (b.ort && b.ort.trim()) ? b.ort.trim().toUpperCase() : "‚Äî";
    rowIcons.appendChild(kgBadge);

    if(b.fragile){
      const fr = document.createElement("div");
      fr.className = "badgeTiny";
      fr.textContent = "üç∑";
      rowIcons.appendChild(fr);
    }

    if(b.heavy){
      const hv = document.createElement("div");
      hv.className = "badgeTiny";
      hv.textContent = "üèãÔ∏è";
      rowIcons.appendChild(hv);
    }

    badges.appendChild(rowIcons);

    const main = document.createElement("div");
    main.className = "main";

    const title = document.createElement("div");
    title.className = "titleLine";

    const code = document.createElement("div");
    code.className = "code";
    code.textContent = id;

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = (b.bez && b.bez.trim()) ? b.bez.trim() : "(ohne Bezeichnung)";

    title.appendChild(code);
    title.appendChild(name);

    const sub = document.createElement("div");
    sub.className = "sub";
    const kg = (b.kg ?? 0) ? `${b.kg} kg` : "";
    const updated = formatLocal(b.updatedAt);
    sub.textContent = `Zuletzt: ${updated || "‚Äî"}${kg ? "  ¬∑  " + kg : ""}`;

    const prev = document.createElement("div");
    prev.className = "preview";
    prev.textContent = contentPreview(b.content);

    main.appendChild(title);
    main.appendChild(sub);
    main.appendChild(prev);

    const open = document.createElement("a");
    open.className = "openBtn";
    open.textContent = "√ñffnen";
    open.href = `./?box=${encodeURIComponent(id)}`;
    open.style.color = "#fff";
    open.style.textDecoration = "none";

    item.appendChild(badges);
    item.appendChild(main);
    item.appendChild(open);

    list.appendChild(item);
  }
}

function togglePill(key, elId){
  filters[key] = !filters[key];
  $(elId).classList.toggle("active", filters[key]);
  render();
}

$("fFragile").addEventListener("click", ()=>togglePill("fragile","fFragile"));
$("fHeavy").addEventListener("click", ()=>togglePill("heavy","fHeavy"));
$("fBlack").addEventListener("click", ()=>togglePill("black","fBlack"));
$("fGrey").addEventListener("click", ()=>togglePill("grey","fGrey"));

$("q").addEventListener("input", render);

$("reload").addEventListener("click", ()=>{
  all = loadAll();
  render();
});

$("clear").addEventListener("click", ()=>{
  $("q").value = "";
  filters = { fragile:false, heavy:false, black:false, grey:false };
  ["fFragile","fHeavy","fBlack","fGrey"].forEach(id=>$(id).classList.remove("active"));
  render();
});

// init
all = loadAll();
render();
</script>
</body>
</html>
