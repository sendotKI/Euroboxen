<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suche ‚Äì Euroboxen</title>
  <style>
    :root{
      --bg: #05070d;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --line: rgba(255,255,255,.12);
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(0,0,0,.22);
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --radius: 18px;

      --ok: #22c55e;

      --grey: #C0C0C0;
      --black: #111;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 30% 10%, #0d1b3a 0%, #05070d 55%, #02030a 100%);
      color: var(--text);
    }

    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px 14px 40px; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
    }

    h1{
      margin: 0 0 12px;
      font-size: 40px;
      letter-spacing: .3px;
    }

    .searchBox{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin-top: 10px;
    }

    .searchInput{
      flex: 1 1 420px;
      min-width: 260px;
      display:flex;
      align-items:center;
      gap:10px;
      border: 1px solid var(--line);
      background: var(--panel2);
      border-radius: 16px;
      padding: 12px 14px;
    }
    .searchInput input{
      width:100%;
      background: transparent;
      border:0;
      outline:0;
      color: var(--text);
      font-size: 16px;
      font-weight: 850;
    }
    .searchInput input::placeholder{ color: rgba(255,255,255,.35); }

    .btnRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .btn{
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--text);
      font-weight: 1000;
      cursor: pointer;
      user-select:none;
      white-space: nowrap;
    }

    .chipRow{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    .chip{
      width: 54px;
      height: 54px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 22px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      outline: 2px solid rgba(34,197,94,.55);
      border-color: rgba(34,197,94,.55);
    }

    .chip.color{
      font-size: 0;
      position: relative;
    }
    .chip.color::after{
      content:"";
      width: 22px;
      height: 22px;
      border-radius: 7px;
      border: 1px solid rgba(255,255,255,.15);
      display:block;
    }
    .chip.black::after{ background: var(--black); }
    .chip.grey::after{ background: var(--grey); }

    .meta{
      margin-top: 10px;
      color: var(--muted);
      font-weight: 900;
    }

    .list{
      margin-top: 14px;
      display:flex;
      flex-direction: column;
      gap: 12px;
    }

    .item{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items: stretch;
    }

    .leftBadge{
      width: 44px;
      min-width: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }
    .badgeDot{
      width: 18px;
      height: 18px;
      border-radius: 7px;
      border: 1px solid rgba(255,255,255,.15);
    }
    .badgeDot.black{ background: var(--black); }
    .badgeDot.grey{ background: var(--grey); }

    .content{
      flex: 1 1 auto;
      min-width: 0;
    }

    .row1{
      display:flex;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }
    .code{
      font-weight: 1000;
      font-size: 28px;
      letter-spacing: .6px;
    }
    .title{
      font-weight: 1000;
      font-size: 22px;
      color: rgba(255,255,255,.92);
    }
    .title.muted{ color: rgba(255,255,255,.65); }

    .row2{
      margin-top: 2px;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      color: rgba(255,255,255,.70);
      font-weight: 900;
      font-size: 14px;
    }

    .iconsInline{
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .mini{
      width: 34px;
      height: 34px;
      border-radius: 13px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
    }
    .kgPill{
      padding: 6px 10px;
      border-radius: 13px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      font-weight: 1000;
      white-space: nowrap;
    }

    .preview{
      margin-top: 8px;
      color: rgba(255,255,255,.86);
      font-weight: 850;
      line-height: 1.25;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    /* WICHTIG: √ñffnen-Button nicht abschneiden */
    .openWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      min-width: 120px;     /* fix */
      flex: 0 0 120px;      /* fix */
    }
    .openBtn{
      width: 100%;
      padding: 12px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-weight: 1000;
      font-size: 16px;
      cursor:pointer;
    }

    @media (max-width: 420px){
      .openWrap{ min-width: 110px; flex-basis: 110px; }
      .code{ font-size: 24px; }
      .title{ font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Suche</h1>

      <div class="searchBox">
        <div class="searchInput">
          <input id="q" placeholder="Suche nach Ort, Bezeichnung, Inhalt, kg‚Ä¶ (z. B. E022)" autocomplete="off" />
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" id="reloadBtn">Neu einlesen</button>
        <button class="btn" id="clearBtn">Leeren</button>
      </div>

      <div class="chipRow" title="Filter">
        <div class="chip" id="fFragile" title="Zerbrechlich">üç∑</div>
        <div class="chip" id="fHeavy" title="Heavy">üèãÔ∏è</div>
        <div class="chip color black" id="fBlack" title="Schwarz"></div>
        <div class="chip color grey" id="fGrey" title="Grau"></div>
      </div>

      <div class="meta" id="meta">Gefunden: 0 / 0 (nur dieses Ger√§t)</div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    // ---- Config: Pfad zu deiner Box-Seite (index.html) ----
    function openUrlFor(code){
      // gleiche Domain, gleicher Ordner:
      // /Euroboxen/?box=E012
      const base = location.origin + location.pathname.replace(/\/suche\.html?$/i, "/");
      return base + "?box=" + encodeURIComponent(code);
    }

    // ---- State ----
    const state = {
      boxes: [],
      filters: { fragile:false, heavy:false, black:false, grey:false },
      query: ""
    };

    // ---- Utils ----
    function parseBoxFromStorage(key, raw){
      try{
        const obj = JSON.parse(raw);
        const code = (obj.code || "").toUpperCase().match(/E\d{3}/);
        if(!code) return null;

        // normalize
        return {
          code: code[0],
          ort: (obj.ort || "").toString().toUpperCase().trim(),
          title: (obj.title || "").toString().trim(),
          text: (obj.text || "").toString(),
          fragile: !!obj.fragile,
          heavy: !!obj.heavy,
          kg: (obj.kg || "").toString().replace(/\D/g,"").slice(0,2),
          color: (obj.color || "").toString().toLowerCase(), // "black"|"grey"|""
          updated: Number(obj.updated || 0) || 0
        };
      }catch(e){
        return null;
      }
    }

    function loadAllBoxes(){
      const out = [];
      for(let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(!k.startsWith("box:E")) continue;
        const raw = localStorage.getItem(k);
        if(!raw) continue;
        const b = parseBoxFromStorage(k, raw);
        if(b) out.push(b);
      }
      // sort: neueste oben
      out.sort((a,b)=> (b.updated||0) - (a.updated||0));
      state.boxes = out;
    }

    function fmtDate(ts){
      if(!ts) return "";
      const d = new Date(ts);
      const pad = (n)=> String(n).padStart(2,"0");
      return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function textPreview(t){
      const lines = (t||"").split("\n").map(s=>s.trim()).filter(Boolean);
      if(!lines.length) return "‚Ä¢";
      return lines.slice(0,3).join("\n");
    }

    function haystack(b){
      return [
        b.code,
        b.ort,
        b.title,
        b.text,
        b.kg ? (b.kg + "kg") : ""
      ].join(" ").toLowerCase();
    }

    function applyFilters(){
      const q = (state.query||"").trim().toLowerCase();
      const f = state.filters;

      return state.boxes.filter(b=>{
        if(f.fragile && !b.fragile) return false;
        if(f.heavy && !b.heavy) return false;
        if(f.black && b.color !== "black") return false;
        if(f.grey && b.color !== "grey") return false;

        if(q){
          return haystack(b).includes(q);
        }
        return true;
      });
    }

    function render(){
      const all = state.boxes.length;
      const res = applyFilters();
      $("meta").textContent = `Gefunden: ${res.length} / ${all} (nur dieses Ger√§t)`;

      const list = $("list");
      list.innerHTML = "";

      for(const b of res){
        const item = document.createElement("div");
        item.className = "item";

        const left = document.createElement("div");
        left.className = "leftBadge";
        const dot = document.createElement("div");
        dot.className = "badgeDot " + (b.color === "grey" ? "grey" : (b.color === "black" ? "black" : ""));
        left.appendChild(dot);

        const content = document.createElement("div");
        content.className = "content";

        const row1 = document.createElement("div");
        row1.className = "row1";
        const code = document.createElement("div");
        code.className = "code";
        code.textContent = b.code;

        const title = document.createElement("div");
        title.className = "title" + (b.title ? "" : " muted");
        title.textContent = b.title ? b.title : "(ohne Bezeichnung)";

        row1.appendChild(code);
        row1.appendChild(title);

        const row2 = document.createElement("div");
        row2.className = "row2";
        const last = document.createElement("div");
        last.textContent = b.updated ? `Zuletzt: ${fmtDate(b.updated)}` : "";

        const icons = document.createElement("div");
        icons.className = "iconsInline";
        if(b.kg && b.kg !== "0"){
          const kg = document.createElement("div");
          kg.className = "kgPill";
          kg.textContent = `${b.kg} kg`;
          icons.appendChild(kg);
        }
        if(b.fragile){
          const m = document.createElement("div");
          m.className = "mini";
          m.textContent = "üç∑";
          icons.appendChild(m);
        }
        if(b.heavy){
          const m = document.createElement("div");
          m.className = "mini";
          m.textContent = "üèãÔ∏è";
          icons.appendChild(m);
        }

        row2.appendChild(last);
        if(icons.childNodes.length) row2.appendChild(icons);

        const prev = document.createElement("div");
        prev.className = "preview";
        prev.textContent = textPreview(b.text);

        content.appendChild(row1);
        content.appendChild(row2);
        content.appendChild(prev);

        const openWrap = document.createElement("div");
        openWrap.className = "openWrap";
        const openBtn = document.createElement("button");
        openBtn.className = "openBtn";
        openBtn.textContent = "√ñffnen";
        openBtn.addEventListener("click", ()=>{
          location.href = openUrlFor(b.code);
        });
        openWrap.appendChild(openBtn);

        item.appendChild(left);
        item.appendChild(content);
        item.appendChild(openWrap);
        list.appendChild(item);
      }
    }

    // ---- UI Events ----
    function toggleChip(name, el){
      state.filters[name] = !state.filters[name];
      el.classList.toggle("active", state.filters[name]);
      render();
    }

    $("q").addEventListener("input", ()=>{
      state.query = $("q").value || "";
      render();
    });

    $("reloadBtn").addEventListener("click", ()=>{
      loadAllBoxes();
      render();
    });

    $("clearBtn").addEventListener("click", ()=>{
      $("q").value = "";
      state.query = "";
      state.filters = { fragile:false, heavy:false, black:false, grey:false };
      ["fFragile","fHeavy","fBlack","fGrey"].forEach(id=>$(id).classList.remove("active"));
      render();
    });

    $("fFragile").addEventListener("click", ()=>toggleChip("fragile", $("fFragile")));
    $("fHeavy").addEventListener("click", ()=>toggleChip("heavy", $("fHeavy")));
    $("fBlack").addEventListener("click", ()=>toggleChip("black", $("fBlack")));
    $("fGrey").addEventListener("click", ()=>toggleChip("grey", $("fGrey")));

    // ---- Start ----
    loadAllBoxes();
    render();
  </script>
</body>
</html>
