<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suche ‚Äì Euroboxen</title>
  <style>
    :root{
      --bg: #05070d;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --accent: #22c55e;
      --danger: #ef4444;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 30% 10%, #0d1b3a 0%, #05070d 55%, #02030a 100%);
      color: var(--text);
    }

    .wrap{
      max-width: 820px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }

    h1{
      margin: 0 0 12px;
      font-size: 44px;
      letter-spacing: .2px;
      font-weight: 900;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .search{
      width:100%;
      display:flex;
      gap:10px;
      align-items:center;
      margin: 10px 0 12px;
    }

    input[type="search"]{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }
    input[type="search"]::placeholder{ color: rgba(255,255,255,.45); }

    .btn{
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--text);
      font-weight: 800;
      cursor: pointer;
      user-select:none;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin: 12px 0 10px;
    }

    .chip{
      width: 52px;
      height: 52px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 22px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 30px rgba(0,0,0,.35) inset;
    }
    .chip.active{
      outline: 2px solid rgba(34,197,94,.55);
      border-color: rgba(34,197,94,.55);
    }

    .meta{
      margin: 8px 0 12px;
      color: var(--muted);
      font-weight: 700;
    }

    .list{
      display:flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }

    .item{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.05);
      padding: 12px 12px;
      display:flex;
      gap:12px;
      align-items:flex-start;

      /* FIX: verhindert, dass der Button gequetscht wird */
      flex-wrap: nowrap;
    }

    .badgeCol{
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-width: 54px;
      align-items:flex-start;
      padding-top: 2px;
    }

    .mini{
      width: 26px;
      height: 26px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.85);
    }

    .square{
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.30);
    }

    .right{
      flex: 1 1 auto;

      /* FIX: iOS braucht das, damit Text k√ºrzt statt Button zu zerdr√ºcken */
      min-width: 0;
    }

    .topline{
      display:flex;
      gap:10px;
      align-items:baseline;
      flex-wrap: wrap;
    }

    .code{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing: .6px;
    }

    .title{
      font-size: 26px;
      font-weight: 900;
      color: rgba(255,255,255,.90);
    }

    .sub{
      margin-top: 2px;
      color: var(--muted);
      font-weight: 700;
    }

    .preview{
      margin-top: 8px;
      color: rgba(255,255,255,.80);
      font-weight: 750;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* FIX: √ñffnen-Button immer breit genug, nicht abgeschnitten */
    a.open{
      margin-left:auto;
      align-self:center;
      text-decoration:none;
      font-weight:900;

      min-width: 96px;     /* genug f√ºr ‚Äû√ñffnen‚Äú */
      text-align: center;
      flex: 0 0 auto;

      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--text);
      white-space:nowrap;
    }

    a.open:active{ transform: translateY(1px); }

    .hint{
      margin-top: 14px;
      color: rgba(255,255,255,.55);
      font-weight: 700;
      font-size: 13px;
      line-height: 1.35;
    }

    @media (max-width: 420px){
      h1{ font-size: 40px; }
      .code{ font-size: 26px; }
      .title{ font-size: 22px; }
      a.open{ min-width: 92px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Suche</h1>

      <div class="search">
        <input id="q" type="search" placeholder="Suche nach Ort, Bezeichnung, Inhalt, kg‚Ä¶ (z. B. E022, K√ºche, 12kg)" autocomplete="off" />
      </div>

      <div class="row" style="gap:12px;">
        <button class="btn" id="reloadBtn">Neu einlesen</button>
        <button class="btn" id="clearBtn">Leeren</button>
      </div>

      <div class="chips" aria-label="Filter">
        <div class="chip" id="fFragile" title="Zerbrechlich">üç∑</div>
        <div class="chip" id="fHeavy" title="Heavy">üèãÔ∏è</div>
        <div class="chip" id="fBlack" title="Schwarz">‚¨õ</div>
        <div class="chip" id="fGrey" title="Grau">‚¨ú</div>
      </div>

      <div class="meta" id="meta">Gefunden: 0 / 0 (nur dieses Ger√§t)</div>

      <div class="list" id="list"></div>

      <div class="hint">
        Hinweis: Die Suche zeigt nur Boxen, die auf <b>diesem Ger√§t</b> bereits gespeichert wurden (localStorage).
        ‚ÄûNeu einlesen‚Äú l√§dt neu aus dem Ger√§tespeicher.
      </div>
    </div>
  </div>

  <script>
    // --- Speicher-Keys (m√ºssen zu deiner index.html passen) ---
    // Erwartet pro Box ein JSON unter key: "box:E012" o.√§.
    // Struktur (Beispiel):
    // { code:"E012", ort:"KUECHE", title:"Halloween", text:"‚Ä¢ ...", fragile:true, heavy:true, kg:"12", color:"grey", updated: 1234567890 }
    //
    // Wenn du andere Keys nutzt, sag kurz welche ‚Äì dann passe ich es an.
    const BOX_PREFIX = "box:";

    const $ = (id) => document.getElementById(id);

    const state = {
      filter: { fragile:false, heavy:false, black:false, grey:false },
      data: []
    };

    function parseBox(obj, key){
      if(!obj || typeof obj !== "object") return null;
      const code = obj.code || (key.startsWith(BOX_PREFIX) ? key.slice(BOX_PREFIX.length) : key);
      const ort = (obj.ort || "").toString();
      const title = (obj.title || obj.bezeichnung || "").toString();
      const text = (obj.text || obj.inhalt || "").toString();
      const fragile = !!obj.fragile;
      const heavy = (obj.heavy === undefined) ? true : !!obj.heavy;
      const kg = (obj.kg || "").toString();
      const color = (obj.color || "").toString().toLowerCase(); // "black" / "grey"
      const updated = Number(obj.updated || obj.last || obj.ts || 0);

      return { code, ort, title, text, fragile, heavy, kg, color, updated };
    }

    function loadAll(){
      const items = [];
      for(let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if(!k || !k.startsWith(BOX_PREFIX)) continue;
        try{
          const raw = localStorage.getItem(k);
          const obj = JSON.parse(raw);
          const box = parseBox(obj, k);
          if(box) items.push(box);
        }catch(e){}
      }

      // sort by code (E001..E200) if possible, else by updated desc
      items.sort((a,b)=>{
        const na = Number((a.code||"").replace(/\D+/g,"")) || 0;
        const nb = Number((b.code||"").replace(/\D+/g,"")) || 0;
        if(na !== nb) return na - nb;
        return (b.updated||0) - (a.updated||0);
      });

      state.data = items;
      render();
    }

    function fmtDate(ts){
      if(!ts) return "";
      const d = new Date(ts);
      const pad = (n)=> String(n).padStart(2,"0");
      return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function normalize(s){
      return (s||"").toString().toLowerCase().trim();
    }

    function matchesFilters(box){
      const f = state.filter;
      if(f.fragile && !box.fragile) return false;
      if(f.heavy && !box.heavy) return false;
      if(f.black && box.color !== "black") return false;
      if(f.grey && box.color !== "grey") return false;
      return true;
    }

    function matchesQuery(box, q){
      if(!q) return true;
      const hay = [
        box.code, box.ort, box.title, box.text, box.kg, box.color
      ].map(normalize).join(" ");
      return hay.includes(q);
    }

    function snippet(text){
      const t = (text||"").trim();
      if(!t) return "‚Ä¢";
      // take first 2 lines
      const lines = t.split("\n").map(s=>s.trim()).filter(Boolean);
      const take = lines.slice(0,2).join(" ¬∑ ");
      return take || "‚Ä¢";
    }

    function boxLink(code){
      // direkt zur index-Seite, die deine Box per ?box= l√§dt
      return `./?box=${encodeURIComponent(code)}`;
    }

    function render(){
      const q = normalize($("q").value);
      const list = $("list");
      list.innerHTML = "";

      const filtered = state.data.filter(b => matchesFilters(b) && matchesQuery(b, q));
      $("meta").textContent = `Gefunden: ${filtered.length} / ${state.data.length} (nur dieses Ger√§t)`;

      for(const b of filtered){
        const item = document.createElement("div");
        item.className = "item";

        const badgeCol = document.createElement("div");
        badgeCol.className = "badgeCol";

        // Farb-Square
        const sq = document.createElement("div");
        sq.className = "square";
        if(b.color === "grey") sq.style.background = "#C0C0C0";
        if(b.color === "black") sq.style.background = "#111";
        badgeCol.appendChild(sq);

        // KG badge, falls gesetzt
        if(b.kg){
          const kg = document.createElement("div");
          kg.className = "mini";
          kg.textContent = "KG";
          badgeCol.appendChild(kg);
        }

        // Icons
        if(b.fragile){
          const ic = document.createElement("div");
          ic.className = "mini";
          ic.style.fontSize = "16px";
          ic.textContent = "üç∑";
          badgeCol.appendChild(ic);
        }
        if(b.heavy){
          const ic2 = document.createElement("div");
          ic2.className = "mini";
          ic2.style.fontSize = "16px";
          ic2.textContent = "üèãÔ∏è";
          badgeCol.appendChild(ic2);
        }

        const right = document.createElement("div");
        right.className = "right";

        const top = document.createElement("div");
        top.className = "topline";

        const code = document.createElement("div");
        code.className = "code";
        code.textContent = b.code || "(?)";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = b.title ? b.title : "(ohne Bezeichnung)";

        top.appendChild(code);
        top.appendChild(title);

        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = b.updated ? `Zuletzt: ${fmtDate(b.updated)}` : "";

        const prev = document.createElement("div");
        prev.className = "preview";
        prev.textContent = snippet(b.text);

        right.appendChild(top);
        right.appendChild(sub);
        right.appendChild(prev);

        const open = document.createElement("a");
        open.className = "open";
        open.textContent = "√ñffnen";
        open.href = boxLink(b.code);

        item.appendChild(badgeCol);
        item.appendChild(right);
        item.appendChild(open);

        list.appendChild(item);
      }
    }

    function toggleChip(key, el){
      state.filter[key] = !state.filter[key];
      el.classList.toggle("active", state.filter[key]);
      render();
    }

    $("reloadBtn").addEventListener("click", loadAll);
    $("clearBtn").addEventListener("click", ()=>{
      $("q").value = "";
      state.filter = { fragile:false, heavy:false, black:false, grey:false };
      $("fFragile").classList.remove("active");
      $("fHeavy").classList.remove("active");
      $("fBlack").classList.remove("active");
      $("fGrey").classList.remove("active");
      render();
    });

    $("fFragile").addEventListener("click", ()=>toggleChip("fragile", $("fFragile")));
    $("fHeavy").addEventListener("click", ()=>toggleChip("heavy", $("fHeavy")));
    $("fBlack").addEventListener("click", ()=>toggleChip("black", $("fBlack")));
    $("fGrey").addEventListener("click", ()=>toggleChip("grey", $("fGrey")));

    $("q").addEventListener("input", render);

    // initial
    loadAll();
  </script>
</body>
</html>
